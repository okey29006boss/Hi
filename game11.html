<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Edu-TKJ Futuristik ‚Äî No Login</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg-1:#0b2440; --bg-2:#082034; --card:#f8fbff; --text:#072038;
    --accent:#61d4ff; --accent2:#8a6cff; --muted:#8faecb;
    --free:#2db84c; --hard:#2d7bd8; --extra:#e0b33a;
    --glass:rgba(255,255,255,0.06);
    --radius:12px;
  }
  *{box-sizing:border-box}
  body{margin:0;min-height:100vh;background:linear-gradient(180deg,var(--bg-1),var(--bg-2));font-family:Orbitron,system-ui,Segoe UI,Roboto;color:var(--card);-webkit-font-smoothing:antialiased}
  a{color:inherit}
  .container{max-width:1100px;margin:28px auto;padding:18px}
  header{display:flex;justify-content:space-between;align-items:center;background:rgba(255,255,255,0.03);padding:14px 18px;border-radius:12px;color:var(--accent)}
  header h1{margin:0;font-size:1.15rem}
  header .subtitle{font-size:0.9rem;color:var(--muted)}
  .profile-area{display:flex;gap:10px;align-items:center}
  .chip{background:var(--card);color:var(--text);padding:8px 12px;border-radius:999px;font-weight:700;cursor:pointer}
  .status-badge{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;font-weight:800}
  .status-dot{width:12px;height:12px;border-radius:50%;display:inline-block}
  .nav{display:flex;gap:8px;margin:16px 0;align-items:center}
  .tab{background:transparent;border:none;padding:10px 14px;border-radius:10px;color:var(--card);cursor:pointer;font-weight:700}
  .tab.active{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#072038;box-shadow:0 12px 40px rgba(0,0,0,0.35)}
  .section{display:none;padding:18px;border-radius:12px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03)}
  .section.active{display:block}
  .title{margin:0 0 8px 0;color:var(--accent)}
  .muted{color:var(--muted)}
  .levels{display:flex;gap:12px;margin:12px 0;flex-wrap:wrap}
  .lvl{width:82px;height:82px;border-radius:12px;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.03);color:var(--card);font-weight:900;cursor:pointer;border:1px solid rgba(255,255,255,0.03)}
  .lvl.current{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#072038;box-shadow:0 10px 30px rgba(0,0,0,0.4)}
  .mat-list{display:flex;flex-wrap:wrap;gap:10px;margin-top:8px}
  .mat-btn{padding:12px 14px;border-radius:10px;background:transparent;color:var(--card);border:1px solid rgba(255,255,255,0.03);cursor:pointer;min-width:220px;font-weight:700;text-align:left}
  .mat-btn.premium{background:rgba(255,255,255,0.02);border:1px dashed rgba(255,255,255,0.03)}
  .mat-detail{margin-top:12px;border-radius:12px;background:var(--card);color:var(--text);padding:20px;box-shadow:0 12px 40px rgba(0,0,0,0.22);line-height:1.6;max-height:66vh;overflow:auto}
  .mat-detail h3{color:#072038;margin-top:0}
  .mat-detail p{margin:8px 0;color:#234f63}
  .mat-detail ul{color:#234f63}
  .card{background:rgba(255,255,255,0.02);border-radius:12px;padding:16px}
  .question{font-weight:800;color:var(--accent)}
  .options{display:grid;gap:10px;margin-top:10px}
  .opt{padding:12px;border-radius:10px;background:rgba(255,255,255,0.03);color:var(--card);cursor:pointer;border:1px solid rgba(255,255,255,0.03);transition:all .15s}
  .opt:hover{transform:translateY(-4px);box-shadow:0 8px 20px rgba(0,0,0,0.25)}
  .opt.sel{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#072038;font-weight:800}
  .nav-row{display:flex;justify-content:space-between;align-items:center;margin-top:14px;gap:8px}
  .btn{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#072038;border:none;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:800}
  .btn.dark{background:var(--card);color:var(--text);border:1px solid rgba(7,34,60,0.06)}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--card)}
  .modal-back{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,6,23,0.6);z-index:10000}
  .modal{background:var(--card);padding:12px;border-radius:10px;color:var(--text);min-width:320px}
  .purchase-row{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:8px;border:1px solid rgba(7,34,60,0.06);background:#f6fbff;margin-bottom:8px}
  .result-list{margin-top:12px;text-align:left;color:#072038;background:#f7fbff;padding:12px;border-radius:10px;max-height:320px;overflow:auto}
  .result-item{padding:8px;border-bottom:1px solid rgba(7,34,60,0.04)}
  .result-item .q{font-weight:700}
  .result-item .meta{font-size:0.9rem;color:#15506a}
  footer{margin-top:20px;padding:12px;text-align:center;color:var(--muted)}
  @media(max-width:900px){
    .levels{justify-content:flex-start}
    .mat-detail{max-height:50vh}
  }
</style>
</head>
<body>

  <!-- PURCHASE MODAL (tetap ada) -->
  <div id="modal" class="modal-back" aria-hidden="true">
    <div class="modal" role="dialog" aria-label="Upgrade">
      <h3 style="margin:0 0 6px 0">Upgrade / Perpanjang Paket (Simulasi)</h3>
      <p class="small" style="margin:0 0 8px 0">Transaksi ini adalah simulasi lokal. Status tersimpan bila akun juga disimpan.</p>
      <div id="purchaseList"></div>
      <div style="text-align:right"><button id="closeModal" type="button" class="btn dark">Tutup</button></div>
    </div>
  </div>

  <!-- APP (langsung tampil ‚Äî login dihapus) -->
  <div class="container" id="app" aria-live="polite">
    <header>
      <div>
        <h1>Edu-TKJ Futuristik</h1>
        <div class="subtitle">Materi, Kuis & Premium ‚Äî Kurikulum</div>
      </div>
      <div class="profile-area">
        <div id="statusBadge" class="status-badge" title="Status paket (klik untuk ubah)"></div>
        <div id="profileArea"></div>
      </div>
    </header>

    <div class="nav" role="tablist" aria-label="Main navigation">
      <button class="tab active" data-tab="materi" type="button">Materi</button>
      <button class="tab" data-tab="kuis" type="button">Kuis</button>
      <button class="tab" data-tab="about" type="button">Tentang</button>
    </div>

    <!-- Materi Section -->
    <section id="materi" class="section active">
      <h2 class="title">Materi TKJ ‚Äî Lengkap (Kurikulum)</h2>
      <p class="muted">Pilih kelas: 10 / 11 / 12. Panel materi berwarna putih untuk kenyamanan baca.</p>

      <div class="levels" id="levelBtns">
        <div class="lvl current" data-level="1" type="button">10</div>
        <div class="lvl" data-level="2" type="button">11</div>
        <div class="lvl" data-level="3" type="button">12</div>
      </div>

      <div class="mat-list" id="matList"></div>
      <div id="matDetail" class="mat-detail"><em>Pilih materi untuk melihat penjelasan lengkapnya.</em></div>
    </section>

    <!-- Quiz Section -->
    <section id="kuis" class="section">
      <h2 class="title">Kuis & Evaluasi</h2>
      <p class="muted">Soal tampil satu-persatu. Tombol "Keluar dari Kuis" tersedia di menu, soal, dan hasil.</p>
      <div id="quizArea" class="card" style="margin-top:10px"><em>Memuat...</em></div>
    </section>

    <!-- About -->
    <section id="about" class="section">
      <h2 class="title">Tentang Aplikasi</h2>
      <div class="card" style="padding:12px">
        <p style="margin:0;color:var(--muted)">Edu-TKJ ‚Äî Versi kurikulum final. Semua pembayaran adalah simulasi (offline). Aplikasi ini dibuat untuk pembelajaran dan demo fitur premium.</p>
      </div>
    </section>

    <footer>
      &copy; Edu-TKJ Futuristik ‚Äî Kurikulum. Simulasi offline. Buat oleh developer.
    </footer>
  </div>

<script>
/* Edu-TKJ Futuristik ‚Äî No Login variant
   - Login UI removed
   - Auto-start as 'Tamu' (or use saved account if present)
   - Premium Hard = 20 soal per level
   - Premium Extra = 40 soal per level
   - Questions unique per level and per tier
*/

document.addEventListener('DOMContentLoaded', () => {
  const STORAGE_KEY = 'edu_tkj_game01_user_v2';
  const $ = s => document.querySelector(s);
  const $$ = s => document.querySelectorAll(s);

  // Elements
  const app = $('#app'), profileArea = $('#profileArea'), statusBadge = $('#statusBadge');
  const modal = $('#modal'), purchaseList = $('#purchaseList'), closeModal = $('#closeModal');
  const tabs = $$('.tab'), sections = $$('.section'), levelBtns = $$('#levelBtns .lvl');
  const matList = $('#matList'), matDetail = $('#matDetail'), quizArea = $('#quizArea');

  // Current user: if a saved user exists, use it; otherwise guest
  let currentUser = (function loadUserSafe(){ try{ const s = localStorage.getItem(STORAGE_KEY); return s ? JSON.parse(s) : null }catch(e){return null} })() || { name:'Tamu', class:'', tier:'free', startDate:null, expireDate:null, lastQuiz:{} };

  // ---------------- Materials (keadaan tetap seperti aslinya) ---------------
  const materials = {
    1: [
      { id:'1-1', title:'1. Pengenalan TKJ', content:`<h3>Pengenalan TKJ</h3><p>Teknik Komputer dan Jaringan (TKJ) mempelajari hardware komputer, sistem operasi, dan jaringan. Materi awal berfokus pada pengenalan komponen, fungsi, serta keselamatan di lab.</p><h4>Langkah Praktik</h4><ol><li>Kenali casing, power switch, slot RAM, dan konektor penyimpanan.</li><li>Catat model motherboard dan serial number setiap perangkat.</li></ol><h4>Ringkasan</h4><ul><li>Praktik aman & dokumentasi penting.</li></ul>`},
      { id:'1-2', title:'2. Komponen Komputer', content:`<h3>Komponen Utama</h3><p>CPU, RAM, Storage (HDD/SSD), Motherboard, PSU, NIC. Fungsi masing-masing dan pemeriksaan dasar.</p>`},
      { id:'1-3', title:'3. Topologi Jaringan', content:`<h3>Topologi</h3><p>Star, Bus, Ring, Mesh ‚Äî kelebihan & kekurangan tiap topologi.</p>`},
      { id:'1-4', title:'4. Media Transmisi', content:`<h3>Media Kabel</h3><p>UTP Cat5e/Cat6, STP, dan Fiber Optic. Penggunaan berdasarkan jarak & bandwidth.</p>`},
      { id:'1-5', title:'5. IP & Subnet (Dasar)', content:`<h3>IP & Subnet</h3><p>Pahami notasi CIDR dan hitungan host usable.</p>`},
      { id:'1-6', title:'6. Model OSI & Protokol', content:`<h3>Model OSI</h3><p>7 layer model ‚Äî gunakan untuk troubleshooting.</p>`},
      { id:'1-7', title:'7. Perangkat Jaringan', content:`<h3>Switch, Router & AP</h3><p>Peran masing-masing perangkat di LAN / WAN.</p>`},
      { id:'1-8', title:'8. NIC & MAC Address', content:`<h3>NIC & MAC</h3><p>Cara melihat MAC & pemakaian di layer 2.</p>`},
      { id:'1-9', title:'9. Dasar Keamanan', content:`<h3>Keamanan</h3><p>Password kuat & enkripsi Wi-Fi (WPA2/3).</p>`},
      { id:'1-10', title:'10. Praktik Dasar', content:`<h3>Perintah Dasar</h3><p>ping, traceroute, ipconfig/ip addr, dan interpretasinya.</p>`}
    ],
    '1_hard': [
      { id:'1-h1', title:'11. Pemeliharaan Jaringan', content:`<h3>Pemeliharaan</h3><p>Checklist rutin & backup konfigurasi.</p>`},
      { id:'1-h2', title:'12. Instalasi Sistem Operasi', content:`<h3>Instalasi</h3><p>Langkah instalasi server & client dasar.</p>`},
      { id:'1-h3', title:'13. IP Lanjutan', content:`<h3>IP Lanjutan</h3><p>Subnetting multi-VLAN & reservation DHCP.</p>`},
      { id:'1-h4', title:'14. Analisis Fisik', content:`<h3>Analisis</h3><p>Penggunaan cable tester & multimeter.</p>`},
      { id:'1-h5', title:'15. Dokumentasi', content:`<h3>Dokumentasi</h3><p>Topologi, BOM & prosedur pemulihan.</p>`}
    ],
    '1_extra': [
      { id:'1-e1', title:'16. Simulasi LAN', content:`<h3>Simulasi</h3><p>Packet Tracer / GNS3 untuk testing topologi.</p>`},
      { id:'1-e2', title:'17. Wireless Optimasi', content:`<h3>Wireless</h3><p>Survey channel & power AP.</p>`},
      { id:'1-e3', title:'18. Audit Keamanan', content:`<h3>Audit</h3><p>Checklist audit & remediasi.</p>`},
      { id:'1-e4', title:'19. Pengujian Bandwidth', content:`<h3>Bandwidth</h3><p>Tools & interpretasi hasil.</p>`},
      { id:'1-e5', title:'20. Studi Kasus Sekolah', content:`<h3>Studi Kasus</h3><p>Desain jaringan sekolah kecil.</p>`}
    ],
    2: [
      { id:'2-1', title:'1. Administrasi Jaringan', content:`<h3>Administrasi</h3><p>Monitoring & incident handling.</p>`},
      { id:'2-2', title:'2. DHCP & DNS', content:`<h3>DHCP & DNS</h3><p>Konsep lease & zone file.</p>`},
      { id:'2-3', title:'3. VLAN & Trunking', content:`<h3>VLAN</h3><p>Pemisahan domain broadcast & trunking 802.1Q.</p>`},
      { id:'2-4', title:'4. Routing Dasar', content:`<h3>Routing</h3><p>Static route & pengantar OSPF.</p>`},
      { id:'2-5', title:'5. NAT & Firewall', content:`<h3>NAT & Firewall</h3><p>Konsep NAT/PAT & rule dasar.</p>`},
      { id:'2-6', title:'6. Monitoring & Troubleshooting', content:`<h3>Monitoring</h3><p>Wireshark, tcpdump & netstat.</p>`},
      { id:'2-7', title:'7. Administrasi Linux', content:`<h3>Linux</h3><p>Perintah ip, systemctl & service management.</p>`},
      { id:'2-8', title:'8. Backup & Recovery', content:`<h3>Backup</h3><p>Full, incremental & differential.</p>`},
      { id:'2-9', title:'9. Wireless Planning', content:`<h3>Planning</h3><p>Survey & capacity planning AP.</p>`},
      { id:'2-10', title:'10. Praktikum Konfigurasi', content:`<h3>Praktikum</h3><p>VLAN, DHCP scope & routing simple.</p>`}
    ],
    '2_hard':[ { id:'2-h1', title:'11. DHCP Advanced', content:'<h3>DHCP Advanced</h3><p>DHCP failover & multiple scopes.</p>'},
               { id:'2-h2', title:'12. Routing Dinamis', content:'<h3>Routing</h3><p>OSPF pengantar & konsep area.</p>'},
               { id:'2-h3', title:'13. VLAN Design', content:'<h3>Design</h3><p>IP plan & segmentasi.</p>'},
               { id:'2-h4', title:'14. Firewall Implementasi', content:'<h3>Firewall</h3><p>Rulebase & logging.</p>'},
               { id:'2-h5', title:'15. Troubleshoot Lanjut', content:'<h3>Troubleshoot</h3><p>Packet capture & analysis.</p>'}
             ],
    '2_extra':[ { id:'2-e1', title:'16. Load Balancing', content:'<h3>LB</h3><p>Round-robin & health checks.</p>'},
                { id:'2-e2', title:'17. VPN', content:'<h3>VPN</h3><p>IPSec/SSL & remote access.</p>'},
                { id:'2-e3', title:'18. Proxy & Caching', content:'<h3>Proxy</h3><p>Optimasi bandwidth.</p>'},
                { id:'2-e4', title:'19. AAA', content:'<h3>AAA</h3><p>RADIUS & central auth.</p>'},
                { id:'2-e5', title:'20. Security Lanjut', content:'<h3>Security</h3><p>Hardening dasar & mitigation.</p>'}
              ],
    3: [
      { id:'3-1', title:'1. Desain Infrastruktur', content:`<h3>Desain</h3><p>Capacity planning & redundancy.</p>`},
      { id:'3-2', title:'2. Data Center & Cabling', content:`<h3>DC</h3><p>Patch panel & airflow.</p>`},
      { id:'3-3', title:'3. Virtualisasi & Cloud', content:`<h3>Virtualisasi</h3><p>VM vs containers.</p>`},
      { id:'3-4', title:'4. Load Balancing', content:`<h3>LB</h3><p>Scaling & health checks.</p>`},
      { id:'3-5', title:'5. IDS/IPS & SOC', content:`<h3>Security Ops</h3><p>SIEM basics.</p>`},
      { id:'3-6', title:'6. Advanced Routing', content:`<h3>Routing Advanced</h3><p>OSPF & BGP pengantar.</p>`},
      { id:'3-7', title:'7. Server & Layanan', content:`<h3>Server</h3><p>Web, DB & file server best practices.</p>`},
      { id:'3-8', title:'8. Otomasi & Scripting', content:`<h3>Otomasi</h3><p>Ansible & scripts.</p>`},
      { id:'3-9', title:'9. Etika Profesi', content:`<h3>Etika</h3><p>Privasi & aturan.</p>`},
      { id:'3-10', title:'10. Proyek Akhir', content:`<h3>Proyek</h3><p>Checklist & dokumentasi.</p>`}
    ],
    '3_hard':[
      { id:'3-h1', title:'11. Virtualisasi Jaringan', content:`<h3>Virtual Net</h3><p>Bridging & overlay.</p>`},
      { id:'3-h2', title:'12. Cloud Service Setup', content:`<h3>Cloud Setup</h3><p>Provisioning VM & backup.</p>`},
      { id:'3-h3', title:'13. IDS/IPS Setup', content:`<h3>IDS/IPS</h3><p>Deploy & tune.</p>`},
      { id:'3-h4', title:'14. Backup & DR', content:`<h3>DR</h3><p>RTO & RPO planning.</p>`},
      { id:'3-h5', title:'15. Monitoring & Performance', content:`<h3>Monitoring</h3><p>Metrics & alerting.</p>`}
    ],
    '3_extra':[
      { id:'3-e1', title:'16. SIEM Dasar', content:`<h3>SIEM</h3><p>Collect & correlate logs.</p>`},
      { id:'3-e2', title:'17. Automation Ansible', content:`<h3>Ansible</h3><p>Playbook & idempotency.</p>`},
      { id:'3-e3', title:'18. Dokumentasi Proyek', content:`<h3>Doc</h3><p>Standar laporan & diagram.</p>`},
      { id:'3-e4', title:'19. Keamanan DC', content:`<h3>Security DC</h3><p>Physical access control.</p>`},
      { id:'3-e5', title:'20. Penilaian & Integrasi', content:`<h3>Integrasi</h3><p>Final project testing.</p>`}
    ]
  };

  // ---------------- Quiz generator (unique, non-duplicating) ---------------
  // Free base questions (explicit 10 per level)
  const freeQ = {
    1: [
      { q:"Apa kepanjangan TKJ?", a:["Teknik Komputer dan Jaringan","Teknologi Komunikasi Jaringan","Teknik Komunikasi Jaringan"], c:0 },
      { q:"Perangkat yang menghubungkan beberapa PC di LAN disebut:", a:["Switch","Modem","Router"], c:0 },
      { q:"Contoh alamat IP privat:", a:["192.168.1.10","8.8.8.8","203.0.113.5"], c:0 },
      { q:"Perintah untuk cek koneksi ke IP:", a:["ping","ipconfig","netstat"], c:0 },
      { q:"Konektor kabel UTP:", a:["RJ45","USB","HDMI"], c:0 },
      { q:"Layer OSI untuk routing:", a:["Layer 3 (Network)","Layer 2 (Data Link)","Layer 1 (Physical)"], c:0 },
      { q:"MAC address ada di layer:", a:["Data Link","Network","Application"], c:0 },
      { q:"DNS berfungsi untuk:", a:["Menerjemahkan nama domain ke IP","Menerjemahkan IP ke MAC","Menyimpan log"], c:0 },
      { q:"Perintah Linux untuk melihat IP:", a:["ip addr","ifconfig /all","show ip"], c:0 },
      { q:"Jumlah host usable di /24:", a:["254","256","128"], c:0 }
    ],
    2: [
      { q:"Fungsi DHCP adalah:", a:["Memberikan IP otomatis","Menjalankan web server","Mengatur VLAN"], c:0 },
      { q:"VLAN berguna untuk:", a:["Memisahkan domain broadcast","Meningkatkan RAM","Mempercepat CPU"], c:0 },
      { q:"Record DNS tipe A menunjuk ke:", a:["Alamat IPv4","Alamat email","Nama host lain"], c:0 },
      { q:"Tool untuk capture paket:", a:["Wireshark","Notepad","Photoshop"], c:0 },
      { q:"SNMP digunakan untuk:", a:["Monitoring perangkat","Transfer file","Membuat VLAN"], c:0 },
      { q:"Backup incremental menyimpan:", a:["Perubahan sejak backup terakhir","Semua data","Hanya konfigurasi"], c:0 },
      { q:"Keamanan Wi-Fi yang direkomendasikan:", a:["WPA2/WPA3","WEP","Open"], c:0 },
      { q:"NAT berguna untuk:", a:["Akses internet via IP publik","Mengganti hostname","Mempercepat jaringan"], c:0 },
      { q:"Firewall sebaiknya:", a:["Memfilter trafik berdasarkan rule","Selalu membuka semua port","Mengizinkan semua ICMP"], c:0 },
      { q:"Traceroute berguna untuk:", a:["Melihat jalur paket ke tujuan","Menambahkan routing","Menampilkan MAC"], c:0 }
    ],
    3: [
      { q:"Load balancer berguna untuk:", a:["Distribusi trafik ke server","Backup data","Mengganti IP"], c:0 },
      { q:"Hypervisor digunakan untuk:", a:["Menjalankan VM","Mengatur kabel","Meningkatkan CPU"], c:0 },
      { q:"HA (High Availability) bertujuan:", a:["Meminimalkan downtime","Meningkatkan downtime","Menambah akses"], c:0 },
      { q:"SaaS adalah model:", a:["Aplikasi via cloud","Hardware service","Pemasangan kabel"], c:0 },
      { q:"SIEM berguna untuk:", a:["Korelasi & analisa log","Membuat VLAN","Mengganti firmware"], c:0 },
      { q:"Snapshot VM digunakan untuk:", a:["Pemulihan cepat","Menambah storage","Mengupdate BIOS"], c:0 },
      { q:"Redundancy artinya:", a:["Cadangan sistem","Menghapus data","Mengkompres file"], c:0 },
      { q:"BOM adalah singkatan dari:", a:["Bill of Materials","Backup On Main","Basic Office Manual"], c:0 },
      { q:"Tabletop exercise berguna untuk:", a:["Latihan incident response","Uji kabel","Cek DNS"], c:0 },
      { q:"Firewall biasanya beroperasi pada layer:", a:["Network/Transport","Physical","Presentation"], c:0 }
    ]
  };

  // deterministic seeded RNG factory
  function makeSeededRNG(seed) {
    let h = 2166136261 >>> 0;
    for (let i = 0; i < seed.length; i++) h = Math.imul(h ^ seed.charCodeAt(i), 16777619) >>> 0;
    return function() {
      h += h << 13; h ^= h >>> 7; h += h << 3;
      return (h >>> 0) / 4294967296;
    };
  }

  // Templates: a collection per level for hard & extra generation.
  // We include diverse templates to ensure uniqueness; templates will be invoked with RNG.
  const templates = {
    1: {
      hard: [
        rng => ({ q:`Pilih alamat IP yang valid untuk jaringan privat:`, a:[`192.168.${Math.floor(rng()*16)}.${Math.floor(rng()*200)+1}`,'8.8.8.8','300.1.1.1'], c:0 }),
        rng => ({ q:`Perangkat yang memisahkan broadcast domain adalah:`, a:['Router','Switch','Hub'], c:0 }),
        rng => ({ q:`Perintah modern untuk melihat konfigurasi IP di Linux adalah:`, a:['ip addr','ifconfig','ifconfig /all'], c:0 }),
        rng => ({ q:`Standar warna umum untuk crimp RJ45 yang sering digunakan adalah:`, a:['T568B','T568A','T568C'], c:0 }),
        rng => ({ q:`Apa fungsi ARP?`, a:['Menerjemahkan IP ke MAC','Menerjemahkan domain ke IP','Menentukan gateway'], c:0 }),
        rng => ({ q:`Tool sederhana untuk menguji latensi jaringan adalah:`, a:['ping','iperf','wireshark'], c:0 }),
        rng => ({ q:`Layer OSI tempat MAC address berada adalah:`, a:['Data Link','Network','Physical'], c:0 }),
        rng => ({ q:`Format MAC address yang benar contohnya:`, a:['00:1A:2B:3C:4D:5E','192.168.0.1','001A-2B3C-4D5E'], c:0 }),
        rng => ({ q:`Kenapa perlu memisahkan SSID tamu dan internal?`, a:['Isolasi akses & keamanan','Meningkatkan throughput','Menurunkan latency'], c:0 }),
        rng => ({ q:`Apa peran switch managed dibanding unmanaged?`, a:['Menyediakan VLAN & monitoring','Lebih murah','Lebih kecil'], c:0 }),
        rng => ({ q:`Jika kabel terlihat putus di tengah, langkah pertama adalah:`, a:['Periksa continuity dengan cable tester','Langsung ganti kabel','Restart perangkat'], c:0 }),
        rng => ({ q:`Jenis kabel yang cocok untuk 1 Gbps sampai 100m biasanya:`, a:['UTP Cat5e/Cat6','Coaxial','Phone cable'], c:0 }),
        rng => ({ q:`Jika paket tidak mencapai tujuan karena fragmentasi, parameter yang perlu dicek adalah:`, a:['MTU','MAC address','Hostname'], c:0 }),
        rng => ({ q:`Protokol yang menerjemahkan nama domain menjadi IP adalah:`, a:['DNS','DHCP','ARP'], c:0 }),
        rng => ({ q:`Manakah yang bukan fungsi router?`, a:['Mencrimp kabel RJ45','Routing antar jaringan','Menghubungkan subnet'], c:0 })
      ],
      extra: [
        rng => ({ q:`Praktik terbaik ketika mendesain jaringan sekolah adalah:`, a:['Membuat IP plan & dokumentasi lengkap','Menggunakan semua DHCP default','Membiarkan semua port terbuka'], c:0 }),
        rng => ({ q:`Keunggulan fiber optic dibanding UTP adalah:`, a:['Jarak lebih jauh dan tahan EMI','Lebih murah','Tidak memerlukan konektor'], c:0 }),
        rng => ({ q:`Subnet mask /28 memberikan berapa host usable?`, a:['14','16','30'], c:0 }),
        rng => ({ q:`Manakah pernyataan benar tentang Spanning Tree Protocol?`, a:['Mencegah loop pada jaringan switching','Menambah bandwidth','Mengubah IP address'], c:0 }),
        rng => ({ q:`Untuk menguji throughput antara dua host, tool yang sering dipakai adalah:`, a:['iperf3','ping','traceroute'], c:0 }),
        rng => ({ q:`Strategi pemilihan channel Wi-Fi untuk mengurangi interferensi biasanya:`, a:['Survey & pilih channel with least overlap','Pilih channel acak','Gunakan channel 1 untuk semua AP'], c:0 }),
        rng => ({ q:`NAT hairpinning memungkinkan:`, a:['Akses IP publik milik jaringan sendiri dari dalam LAN','Mengganti MAC address','Menambah DNS record'], c:0 }),
        rng => ({ q:`Mengapa menandai kabel dan label penting?`, a:['Memudahkan troubleshooting & dokumentasi','Agar kabel terlihat bagus','Mengganti kabel lebih cepat'], c:0 }),
        rng => ({ q:`Prinsip dasar QoS adalah:`, a:['Prioritaskan trafik sensitif seperti voice & video','Menambah bandwidth ke semua','Mengurangi paket kecil'], c:0 }),
        rng => ({ q:`Saat melakukan crimping, standar T568B urutan warna dimulai dari:`, a:['Putih-Orange','Putih-Hijau','Putih-Biru'], c:0 }),
        rng => ({ q:`Alasan mem-backup konfigurasi perangkat jaringan sebelum update adalah:`, a:['Mempermudah rollback jika update gagal','Tidak perlu backup','Mengganti perangkat otomatis'], c:0 }),
        rng => ({ q:`Apa itu VLAN tagging (802.1Q)?`, a:['Menyisipkan tag VLAN pada frame untuk trunking','Mengganti IP address','Menghapus broadcast'], c:0 }),
        rng => ({ q:`Jika ingin mengisolasi traffic printer dari user biasa, solusi praktis adalah:`, a:['Tempatkan printer pada VLAN terpisah','Sambungkan ke switch berbeda tanpa routing','Hubungkan ke Wi-Fi tamu'], c:0 }),
        rng => ({ q:`Manakah protokol yang digunakan untuk manajemen perangkat jaringan secara remote (command-line)?`, a:['SSH','FTP','HTTP (tanpa TLS)'], c:0 }),
        rng => ({ q:`Alasan memilih managed switch pada lab adalah:`, a:['Kontrol VLAN, monitoring dan QoS','Lebih murah','Tidak perlu konfigurasi'], c:0 })
      ]
    },

    2: {
      hard: [
        rng => ({ q:`Apa tujuan penggunaan VLAN pada switch?`, a:['Memisahkan domain broadcast','Meningkatkan clock speed','Mengganti MAC address'], c:0 }),
        rng => ({ q:`Bagaimana trunk 802.1Q bekerja secara singkat?`, a:['Membedakan VLAN dengan tag di frame','Meningkatkan kecepatan physical link','Menyembunyikan IP address'], c:0 }),
        rng => ({ q:`Contoh protokol routing interior yang biasa digunakan adalah:`, a:['OSPF','BGP','FTP'], c:0 }),
        rng => ({ q:`Perintah untuk melihat routing table di Linux adalah:`, a:['ip route show','route print','show ip route'], c:0 }),
        rng => ({ q:`Jika ingin memblokir akses telnet (port 23), langkah praktis adalah:`, a:['Tambahkan rule deny pada firewall','Abaikan saja','Matikan semua switch'], c:0 }),
        rng => ({ q:`Handshake TCP standar terdiri dari:`, a:['SYN, SYN-ACK, ACK','HELLO, WORLD, OK','GET, POST, RESP'], c:0 }),
        rng => ({ q:`DHCP reservation sering menggunakan referensi:`, a:['MAC address perangkat','Nama user','Tanggal instalasi'], c:0 }),
        rng => ({ q:`Tool monitoring SNMP populer adalah:`, a:['Zabbix/PRTG','Notepad++','Photoshop'], c:0 }),
        rng => ({ q:`NAT overload juga dikenal sebagai:`, a:['PAT','Static NAT','Proxy ARP'], c:0 }),
        rng => ({ q:`Jenis backup yang hanya menyimpan perubahan sejak backup terakhir disebut:`, a:['Incremental','Full','Mirror'], c:0 }),
        rng => ({ q:`Apa yang dimaksud dengan 'split horizon' dalam routing?`, a:['Teknik untuk mengurangi routing loop pada distance-vector','Metode backup','Fitur switch'], c:0 }),
        rng => ({ q:`Alat yang berguna untuk analisis paket secara mendalam adalah:`, a:['Wireshark','Notepad','Paint'], c:0 }),
        rng => ({ q:`Perintah untuk memeriksa koneksi TCP aktif di Linux adalah:`, a:['ss/netstat','ping','ifconfig'], c:0 }),
        rng => ({ q:`Metode authentication terpusat untuk jaringan wireless enterprise sering memakai:`, a:['RADIUS + WPA2/WPA3 Enterprise','WEP','Open'], c:0 }),
        rng => ({ q:`Apa fungsi NAT statis?`, a:['Pemetaan 1:1 IP privat ke IP publik','Dynamic port mapping','Tidak ada mapping'], c:0 })
      ],
      extra: [
        rng => ({ q:`Perbedaan utama OSPF dibanding RIP adalah:`, a:['OSPF link-state, RIP distance-vector','Keduanya sama','RIP lebih kompleks'], c:0 }),
        rng => ({ q:`Solusi isolasi guest Wi-Fi yang efektif biasanya melibatkan:`, a:['Guest SSID + VLAN + firewall rules','Satu SSID untuk semua','Nonaktifkan DHCP'], c:0 }),
        rng => ({ q:`Load balancer health check biasa memeriksa:`, a:['Respons HTTP/TCP atau status service','Kecepatan kabel','MAC address'], c:0 }),
        rng => ({ q:`VPN remote access aman umumnya menggunakan:`, a:['IPSec atau SSL/TLS','Telnet','FTP'], c:0 }),
        rng => ({ q:`Cache proxy dapat membantu mengurangi:`, a:['Bandwidth ke internet','Waktu boot PC','Kebutuhan listrik'], c:0 }),
        rng => ({ q:`Teknik rate-limiting pada firewall berguna untuk:`, a:['Mencegah abuse & DDoS kecil','Meningkatkan latency','Mengganti IP'], c:0 }),
        rng => ({ q:`Konsep 'failover' pada DHCP berarti:`, a:['Redundansi server DHCP untuk ketersediaan','Hanya satu server selalu aktif','DHCP otomatis nonaktif'], c:0 }),
        rng => ({ q:`Manakah yang termasuk best practice untuk logging firewall?`, a:['Simpan log terpusat & rotasi berkala','Jangan simpan log','Simpan log di setiap PC'], c:0 }),
        rng => ({ q:`Apa itu 'port security' di switch?`, a:['Mengikat MAC ke port untuk membatasi akses','Fitur untuk menambah port','Monitoring CPU switch'], c:0 }),
        rng => ({ q:`Teknik VLAN pruning dipakai untuk:`, a:['Mengurangi VLAN yang lewat di trunk link','Menambah VLAN','Menduplicate traffic'], c:0 })
      ]
    },

    3: {
      hard: [
        rng => ({ q:`BGP umumnya digunakan untuk:`, a:['Pertukaran route antar-AS di internet','Routing internal kantor kecil','Mengganti DNS'], c:0 }),
        rng => ({ q:`Snapshot VM biasanya dipakai untuk:`, a:['Rollback cepat ke state sebelumnya','Meningkatkan CPU','Menyimpan logs'], c:0 }),
        rng => ({ q:`SIEM berperan untuk:`, a:['Korelasi & analisa log serta alerting','Mengganti firewall','Menambah VLAN'], c:0 }),
        rng => ({ q:`Salah satu tool automasi infrastruktur populer adalah:`, a:['Ansible / Terraform','Notepad','Photoshop'], c:0 }),
        rng => ({ q:`High Availability dicapai dengan:`, a:['Redundansi & mekanisme failover','Menambahkan RAM','Mengganti kabel'], c:0 }),
        rng => ({ q:`Konsep RTO dan RPO terkait dengan:`, a:['Disaster Recovery planning','Routing table','MAC binding'], c:0 })
      ],
      extra: [
        rng => ({ q:`Infrastructure as Code (IaC) sering menggunakan:`, a:['Terraform/Ansible','Telnet','Manual scripts'], c:0 }),
        rng => ({ q:`Untuk observability di skala besar, yang ideal adalah:`, a:['Metrics + Logs + Traces (terpusat)','Spreadsheet','Email manual'], c:0 }),
        rng => ({ q:`Strategi DR yang baik harus menentukan:`, a:['RTO, RPO & recovery runbook','Hanya backup harian','Hanya snapshot VM'], c:0 }),
        rng => ({ q:`Manakah yang termasuk langkah hardening dasar pada device jaringan?`, a:['Ganti password default & update firmware','Biarkan default','Nonaktifkan logging'], c:0 })
      ]
    }
  };

  // Build unique bank function with target sizes:
  const TARGET_HARD = 20;   // per level (user requested 20)
  const TARGET_EXTRA = 40;  // per level (user requested 40)

  function normalizeTextForCompare(s){
    if(!s) return '';
    return s.q ? s.q.trim().toLowerCase().replace(/\s+/g,' ') : String(s).trim().toLowerCase();
  }

  function existsInListByQ(qobj, list){
    const nq = normalizeTextForCompare(qobj);
    for (let i=0;i<list.length;i++){
      if (normalizeTextForCompare(list[i]) === nq) return true;
      if (typeof list[i] === 'object' && list[i].q && normalizeTextForCompare(list[i]) === nq) return true;
    }
    return false;
  }

  function buildBankForLevel(level){
    // free: explicit
    const free = (freeQ[level] || []).map(item => ({ q: item.q, a: item.a.slice(0,3), c: item.c }));

    const hardRng = makeSeededRNG('hard-' + level + '-v4');
    const extraRng = makeSeededRNG('extra-' + level + '-v4');

    const hardTemplates = templates[level].hard || [];
    const extraTemplates = templates[level].extra || [];

    const hard = [];
    let idx = 0;
    // Generate hard until TARGET_HARD unique
    while (hard.length < TARGET_HARD && idx < 2000){
      const t = hardTemplates[idx % hardTemplates.length];
      const qobj = t(hardRng);
      if (!existsInListByQ(qobj, free) && !existsInListByQ(qobj, hard)) hard.push(qobj);
      idx++;
    }
    // If shortage (unlikely), fall back to simple modifications of existing hard entries
    while (hard.length < TARGET_HARD){
      const base = hard[hard.length % Math.max(1, hard.length)];
      const q = base ? (base.q + ' (variasi)') : `Soal tambahan level ${level} Hard #${hard.length+1}`;
      hard.push({ q, a: ['Opsi A','Opsi B','Opsi C'], c:0 });
    }

    // Generate extra until TARGET_EXTRA unique (allow mixing templates)
    const extra = [];
    idx = 0;
    while (extra.length < TARGET_EXTRA && idx < 5000){
      const source = (idx % 2 === 0 && extraTemplates.length) ? extraTemplates : hardTemplates;
      const t = source[idx % source.length];
      const qobj = t(extraRng);
      if (!existsInListByQ(qobj, free) && !existsInListByQ(qobj, hard) && !existsInListByQ(qobj, extra)) extra.push(qobj);
      idx++;
    }
    // fallback if needed
    while (extra.length < TARGET_EXTRA){
      const i = extra.length;
      extra.push({ q: `Soal tambahan level ${level} Extra #${i+1}`, a:['Opsi A','Opsi B','Opsi C'], c:0 });
    }

    // Normalize option lengths to 3 and c boundaries
    function norm(item){
      const a = Array.isArray(item.a) ? item.a.slice(0,3) : ['A','B','C'];
      while (a.length < 3) a.push('Pilihan lain');
      const c = (typeof item.c === 'number') ? Math.max(0, Math.min(2, item.c)) : 0;
      return { q: String(item.q).trim(), a, c };
    }

    return {
      free: free.map(norm),
      hard: hard.map(norm),
      extra: extra.map(norm)
    };
  }

  // Build banks for levels 1..3
  const generatedBanks = {};
  for (let L=1; L<=3; L++){
    generatedBanks[L] = buildBankForLevel(L);
  }

  // Compose final quizBank object used by app
  const quizBank = { free: {}, hard: {}, extra: {} };
  [1,2,3].forEach(l => {
    quizBank.free[l] = generatedBanks[l].free;
    quizBank.hard[l] = generatedBanks[l].hard;
    quizBank.extra[l] = generatedBanks[l].extra;
  });

  // ----------------- Helper utilities & UI -----------------
  function esc(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, ch=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[ch])); }
  function saveUser(u){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(u)); }catch(e){console.warn(e)} }
  function loadUser(){ try{ const s = localStorage.getItem(STORAGE_KEY); return s ? JSON.parse(s) : null }catch(e){return null} }
  function clearUserStorage(){ localStorage.removeItem(STORAGE_KEY); localStorage.removeItem(STORAGE_KEY+'_progress'); }

  function renderStatusBadge(){
    statusBadge.innerHTML = '';
    if(!currentUser){
      statusBadge.innerHTML = `<div style="padding:6px 10px;border-radius:8px;background:rgba(255,255,255,0.02);color:var(--muted);font-weight:700">Status: Guest</div>`;
      return;
    }
    let color = 'var(--free)', text = 'Free User';
    if(currentUser.tier === 'hard'){ color = 'var(--hard)'; text = 'Premium Hard' }
    if(currentUser.tier === 'extra'){ color = 'var(--extra)'; text = 'Premium Extra' }
    statusBadge.innerHTML = `<div style="display:flex;align-items:center;gap:8px">
      <span class="status-dot" style="background:${color}"></span>
      <div style="font-weight:800;color:var(--text);padding:4px 8px;border-radius:8px;background:rgba(255,255,255,0.9)">${esc(text)}</div>
    </div>`;
    statusBadge.style.cursor = 'pointer';
    statusBadge.onclick = openPurchaseModal;
  }

  function renderProfile(){
    profileArea.innerHTML = '';
    const chip = document.createElement('div'); chip.className='chip';
    chip.innerHTML = `${esc(currentUser.name || 'Tamu')} ‚Ä¢ ${esc(currentUser.class || '')} <span style="margin-left:8px;font-weight:700;color:#07405a">${currentUser.tier === 'hard' ? 'üíé Hard' : currentUser.tier === 'extra' ? 'üî• Extra' : 'üü¢ Free'}</span>`;
    chip.addEventListener('click', openPurchaseModal);
    profileArea.appendChild(chip);
    renderStatusBadge();
  }

  // Tabs
  function switchTab(name){
    tabs.forEach(t => t.classList.toggle('active', t.dataset.tab === name));
    sections.forEach(s => s.id === name ? s.classList.add('active') : s.classList.remove('active'));
  }
  tabs.forEach(t => t.addEventListener('click', ()=> switchTab(t.dataset.tab)));

  // Render materials
  function renderMaterials(level){
    matList.innerHTML = '';
    const freeArr = materials[level] || [];
    freeArr.forEach(m=>{
      const btn = document.createElement('button'); btn.type='button'; btn.className='mat-btn';
      btn.innerHTML = `<div style="font-weight:800">${esc(m.title)}</div><div style="font-size:12px;color:var(--muted)">Free</div>`;
      btn.addEventListener('click', ()=> { matDetail.innerHTML = m.content; matDetail.scrollTop = 0; });
      matList.appendChild(btn);
    });

    const hardArr = materials[level + '_hard'] || [];
    if(currentUser && (currentUser.tier === 'hard' || currentUser.tier === 'extra')){
      hardArr.forEach(m=>{
        const btn = document.createElement('button'); btn.type='button'; btn.className='mat-btn premium';
        btn.innerHTML = `<div style="font-weight:800">${esc(m.title)}</div><div style="font-size:12px;color:var(--muted)">Premium Hard</div>`;
        btn.addEventListener('click', ()=> { matDetail.innerHTML = m.content; matDetail.scrollTop = 0; });
        matList.appendChild(btn);
      });
    } else {
      if(hardArr.length){
        const lock = document.createElement('div'); lock.style.width='100%'; lock.style.color='var(--muted)';
        lock.innerHTML = `<small>Upgrade ke <strong>Premium Hard</strong> untuk membuka ${hardArr.length} materi lanjutan.</small>`;
        matList.appendChild(lock);
      }
    }

    const extraArr = materials[level + '_extra'] || [];
    if(currentUser && currentUser.tier === 'extra'){
      extraArr.forEach(m=>{
        const btn = document.createElement('button'); btn.type='button'; btn.className='mat-btn premium';
        btn.innerHTML = `<div style="font-weight:800">${esc(m.title)}</div><div style="font-size:12px;color:var(--muted)">Premium Extra</div>`;
        btn.addEventListener('click', ()=> { matDetail.innerHTML = m.content; matDetail.scrollTop = 0; });
        matList.appendChild(btn);
      });
    } else {
      if(extraArr.length){
        const note = document.createElement('div'); note.style.width='100%'; note.style.color='var(--muted)';
        note.innerHTML = `<small>Upgrade ke <strong>Premium Extra</strong> untuk membuka ${extraArr.length} materi tambahan lagi.</small>`;
        matList.appendChild(note);
      }
    }

    const first = matList.querySelector('.mat-btn');
    if(first) first.click();
    else matDetail.innerHTML = '<em>Tidak ada materi untuk level ini.</em>';
  }

  levelBtns.forEach(b=>{
    b.addEventListener('click', ()=>{
      levelBtns.forEach(x=> x.classList.remove('current'));
      b.classList.add('current');
      renderMaterials(parseInt(b.dataset.level,10));
    });
  });

  // ---------- QUIZ flow ----------
  let bank = null, quizLevel = 1, qIndex = 0, answers = [];

  function getBankForUser(){
    const tier = (currentUser && currentUser.tier) ? currentUser.tier : 'free';
    if(tier === 'hard') return quizBank.hard;
    if(tier === 'extra') return quizBank.extra;
    return quizBank.free;
  }

  function initQuiz(){
    bank = getBankForUser();
    quizLevel = 1; qIndex = 0; answers = new Array(bank[quizLevel].length).fill(null);
    renderQuizMenu();
  }

  function renderQuizMenu(){
    quizArea.innerHTML = `
      <div>
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <h3 style="margin:0;color:var(--accent)">Pilih Level Kuis</h3>
            <p class="muted" style="margin:6px 0">Free=10 / Hard=${TARGET_HARD} / Extra=${TARGET_EXTRA} per level (soal unik tiap tier).</p>
          </div>
          <div><button class="btn ghost" id="exitMenu">Keluar dari Kuis</button></div>
        </div>
        <div style="display:flex;gap:8px;margin-top:12px">
          <button class="btn" type="button" onclick="startQuiz(1)">Level 1 (Kelas 10)</button>
          <button class="btn" type="button" onclick="startQuiz(2)">Level 2 (Kelas 11)</button>
          <button class="btn" type="button" onclick="startQuiz(3)">Level 3 (Kelas 12)</button>
        </div>
      </div>
    `;
    const exitBtn = document.getElementById('exitMenu');
    if(exitBtn) exitBtn.addEventListener('click', ()=> { switchTab('materi'); initQuiz(); });
  }

  // Save & load per-quiz progress
  function saveProgress(){
    if(!currentUser) return;
    const key = STORAGE_KEY + '_progress';
    const all = JSON.parse(localStorage.getItem(key) || '{}');
    all[currentUser.name||'guest'] = { level: quizLevel, qIndex, answers };
    localStorage.setItem(key, JSON.stringify(all));
  }
  function loadProgress(){
    if(!currentUser) return null;
    const key = STORAGE_KEY + '_progress';
    const all = JSON.parse(localStorage.getItem(key) || '{}');
    return all[currentUser.name||'guest'] || null;
  }
  function clearProgress(){
    if(!currentUser) return;
    const key = STORAGE_KEY + '_progress';
    const all = JSON.parse(localStorage.getItem(key) || '{}');
    delete all[currentUser.name||'guest'];
    localStorage.setItem(key, JSON.stringify(all));
  }

  window.startQuiz = function(level){
    bank = getBankForUser();
    quizLevel = level;
    qIndex = 0;
    answers = new Array(bank[level].length).fill(null);
    const pr = loadProgress();
    if(pr && pr.level === level && pr.answers && pr.answers.length === bank[level].length){
      if(confirm('Lanjutkan kuis sebelumnya pada posisi terakhir?')) {
        qIndex = pr.qIndex || 0;
        answers = pr.answers.slice();
      } else clearProgress();
    }
    renderQuestion();
  };

  function renderQuestion(){
    const data = bank[quizLevel];
    if(!data || !data.length){ quizArea.innerHTML = '<em>Tidak ada soal.</em>'; return; }
    const q = data[qIndex], total = data.length, sel = answers[qIndex];
    quizArea.innerHTML = `
      <div>
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:800;color:var(--accent)">Kuis Level ${quizLevel}</div>
          <div class="muted">Soal ${qIndex+1} / ${total}</div>
        </div>

        <div style="margin-top:10px" class="question">${esc(q.q)}</div>
        <div class="options" id="opts">${q.a.map((o,i)=>`<div class="opt ${(sel===i)?'sel':''}" data-idx="${i}">${String.fromCharCode(65+i)}. ${esc(o)}</div>`).join('')}</div>

        <div class="nav-row">
          <div style="display:flex;gap:8px">
            <button class="btn dark" id="prevBtn" ${qIndex===0?'disabled':''}>Sebelumnya</button>
            ${qIndex < total-1 ? '<button class="btn" id="nextBtn">Selanjutnya</button>' : '<button class="btn" id="finishBtn">Selesai</button>'}
          </div>
          <div style="display:flex;gap:8px">
            <button class="btn ghost" id="exitBtn">Keluar dari Kuis</button>
          </div>
        </div>
      </div>
    `;
    document.querySelectorAll('#opts .opt').forEach(el=>{
      el.addEventListener('click', ()=> {
        const idx = parseInt(el.dataset.idx,10);
        answers[qIndex] = idx;
        saveProgress();
        renderQuestion();
      });
    });
    const prev = $('#prevBtn'), next = $('#nextBtn'), finish = $('#finishBtn');
    if(prev) prev.addEventListener('click', ()=> { if(qIndex>0){ qIndex--; saveProgress(); renderQuestion(); }});
    if(next) next.addEventListener('click', ()=> { if(qIndex < data.length-1){ qIndex++; saveProgress(); renderQuestion(); }});
    if(finish) finish.addEventListener('click', finishQuiz);
    const exitBtn = $('#exitBtn');
    if(exitBtn) exitBtn.addEventListener('click', ()=> {
      if(confirm('Keluar dari kuis? Progres akan disimpan.')) { saveProgress(); switchTab('materi'); initQuiz(); }
    });
  }

  function finishQuiz(){
    const data = bank[quizLevel];
    let correct = 0;
    for(let i=0;i<data.length;i++) if(answers[i] === data[i].c) correct++;
    const total = data.length; const percent = Math.round((correct/total)*100);
    const kategori = percent <= 60 ? 'Pemula' : percent <= 85 ? 'Menengah' : 'Ahli';
    if(currentUser){
      currentUser.lastQuiz = currentUser.lastQuiz || {};
      currentUser.lastQuiz['L'+quizLevel] = { correct, total, percent, kategori, date: new Date().toISOString() };
      saveUser(currentUser);
      renderProfile();
    }
    clearProgress();

    let html = `
      <div style="text-align:center">
        <h2 style="margin:6px 0;color:var(--accent)">Hasil Kuis Level ${quizLevel}</h2>
        <p class="muted">Benar: <strong style="color:var(--card)">${correct}</strong> / ${total}</p>
        <p class="muted">Nilai: <strong style="color:var(--card)">${percent}%</strong></p>
        <p class="muted">${kategori}</p>
        <div style="margin-top:10px;display:flex;gap:8px;justify-content:center">
          <button class="btn" id="retryBtn">Ulangi</button>
          <button class="btn dark" id="backBtn">Kembali</button>
          <button class="btn ghost" id="exitResultBtn">Keluar dari Kuis</button>
        </div>
      </div>
    `;
    const tier = currentUser && currentUser.tier ? currentUser.tier : 'free';
    if(tier === 'hard' || tier === 'extra'){
      html += `<div class="result-list"><h4 style="margin:6px 0">Daftar Jawaban</h4>`;
      for(let i=0;i<data.length;i++){
        const ua = answers[i], ci = data[i].c;
        const isCorrect = ua === ci;
        const uaText = (ua === null) ? '<em>Tidak dijawab</em>' : esc(data[i].a[ua]);
        const caText = esc(data[i].a[ci]);
        html += `<div class="result-item"><div class="q">#${i+1}. ${esc(data[i].q)}</div><div class="meta">Jawaban Anda: ${uaText} ‚Äî Jawaban Benar: ${caText} ${isCorrect? '‚úîÔ∏è' : '‚ùå'}</div></div>`;
      }
      html += `</div>`;
    } else {
      html += `<p class="muted" style="margin-top:12px">Upgrade ke Premium Hard/Extra untuk melihat daftar jawaban lengkap & pembahasan.</p>`;
    }

    quizArea.innerHTML = html;
    $('#retryBtn') && $('#retryBtn').addEventListener('click', ()=> { answers = new Array(data.length).fill(null); qIndex=0; saveProgress(); renderQuestion(); });
    $('#backBtn') && $('#backBtn').addEventListener('click', ()=> initQuiz());
    $('#exitResultBtn') && $('#exitResultBtn').addEventListener('click', ()=> { switchTab('materi'); initQuiz(); });
  }

  // ---------- Purchase logic ----------
  const PRICES = {
    free_to_hard: 25000,
    free_to_extra: 45000,
    hard_to_extra_upgrade: 20000,
    renew_hard: 20000,
    renew_extra: 35000
  };

  function openPurchaseModal(){
    purchaseList.innerHTML = '';
    if(!currentUser){
      const p1 = document.createElement('div'); p1.className='purchase-row';
      p1.innerHTML = `<div><strong>Free ‚Üí Premium Hard</strong><br><small>Rp ${PRICES.free_to_hard.toLocaleString()}</small></div><div><button class="btn" data-action="buy" data-tier="hard" data-price="${PRICES.free_to_hard}">Beli</button></div>`;
      purchaseList.appendChild(p1);
      const p2 = document.createElement('div'); p2.className='purchase-row';
      p2.innerHTML = `<div><strong>Free ‚Üí Premium Extra</strong><br><small>Rp ${PRICES.free_to_extra.toLocaleString()}</small></div><div><button class="btn" data-action="buy" data-tier="extra" data-price="${PRICES.free_to_extra}">Beli</button></div>`;
      purchaseList.appendChild(p2);
    } else {
      if(currentUser.tier === 'free'){
        const a = document.createElement('div'); a.className='purchase-row';
        a.innerHTML = `<div><strong>Free ‚Üí Premium Hard</strong><br><small>Rp ${PRICES.free_to_hard.toLocaleString()}</small></div><div><button class="btn" data-action="buy" data-tier="hard" data-price="${PRICES.free_to_hard}">Beli</button></div>`;
        purchaseList.appendChild(a);
        const b = document.createElement('div'); b.className='purchase-row';
        b.innerHTML = `<div><strong>Free ‚Üí Premium Extra</strong><br><small>Rp ${PRICES.free_to_extra.toLocaleString()}</small></div><div><button class="btn" data-action="buy" data-tier="extra" data-price="${PRICES.free_to_extra}">Beli</button></div>`;
        purchaseList.appendChild(b);
      } else if(currentUser.tier === 'hard'){
        const up = document.createElement('div'); up.className='purchase-row';
        up.innerHTML = `<div><strong>Upgrade Hard ‚Üí Extra</strong><br><small>Rp ${PRICES.hard_to_extra_upgrade.toLocaleString()}</small></div><div><button class="btn" data-action="upgrade" data-tier="extra" data-price="${PRICES.hard_to_extra_upgrade}">Upgrade</button></div>`;
        purchaseList.appendChild(up);
        const renew = document.createElement('div'); renew.className='purchase-row';
        renew.innerHTML = `<div><strong>Perpanjang Premium Hard</strong><br><small>Rp ${PRICES.renew_hard.toLocaleString()}</small></div><div><button class="btn" data-action="renew" data-tier="hard" data-price="${PRICES.renew_hard}">Perpanjang</button></div>`;
        purchaseList.appendChild(renew);
      } else if(currentUser.tier === 'extra'){
        const upnote = document.createElement('div'); upnote.className='purchase-row';
        upnote.innerHTML = `<div><strong>Premium Extra aktif</strong><br><small>Kadaluarsa: ${currentUser.expireDate ? new Date(currentUser.expireDate).toLocaleDateString() : '-'}</small></div><div></div>`;
        purchaseList.appendChild(upnote);
        const renew2 = document.createElement('div'); renew2.className='purchase-row';
        renew2.innerHTML = `<div><strong>Perpanjang Premium Extra</strong><br><small>Rp ${PRICES.renew_extra.toLocaleString()}</small></div><div><button class="btn" data-action="renew" data-tier="extra" data-price="${PRICES.renew_extra}">Perpanjang</button></div>`;
        purchaseList.appendChild(renew2);
      }
    }

    purchaseList.querySelectorAll('button').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const action = btn.dataset.action;
        const tier = btn.dataset.tier;
        const price = parseInt(btn.dataset.price,10);
        handlePurchase(action || 'buy', tier, price);
      });
    });

    modal.style.display = 'flex'; modal.setAttribute('aria-hidden','false');
  }
  function closePurchaseModal(){ modal.style.display='none'; modal.setAttribute('aria-hidden','true'); }
  closeModal.addEventListener('click', closePurchaseModal);

  function handlePurchase(action, tier, price){
    if(!confirm(`Konfirmasi: ${action.toUpperCase()} paket ${tier} ‚Äî Rp ${price.toLocaleString()} (simulasi)?`)) return;
    if(!currentUser){
      currentUser = { name:'Tamu', class:'', tier:'free', startDate:null, expireDate:null, lastQuiz:{} };
    }
    const now = new Date();
    const expire = new Date(now.getTime() + 30*24*60*60*1000);
    if(action === 'buy' || action === 'upgrade'){
      currentUser.tier = tier;
      currentUser.startDate = now.toISOString();
      currentUser.expireDate = expire.toISOString();
    } else if(action === 'renew'){
      const base = currentUser.expireDate ? new Date(currentUser.expireDate) : now;
      const start = base > now ? base : now;
      const newExp = new Date(start.getTime() + 30*24*60*60*1000);
      currentUser.startDate = now.toISOString();
      currentUser.expireDate = newExp.toISOString();
      currentUser.tier = tier;
    }
    // Persist only if previously there was a saved user (to respect original behavior); otherwise keep in memory
    try {
      const saved = localStorage.getItem(STORAGE_KEY);
      if(saved) saveUser(currentUser);
    } catch(e){}
    alert('Sukses (simulasi). Paket aktif sampai ' + new Date(currentUser.expireDate).toLocaleDateString());
    closePurchaseModal();
    renderProfile();
    renderMaterials(getCurrentLevel());
    initQuiz();
  }

  function getCurrentLevel(){ const cur = document.querySelector('.lvl.current'); return cur ? parseInt(cur.dataset.level,10) : 1; }

  // ---------- Start app ----------
  function startApp(){
    app.style.display = 'block';
    renderProfile();
    renderMaterials(1);
    initQuiz();
    switchTab('materi');
    console.log('Aplikasi dimulai sebagai', currentUser.name, currentUser.tier);
  }

  // initialize
  startApp();

  // debug helper (convenience)
  window._edu_tkj_game01 = {
    getUser: ()=> currentUser,
    saveUser: ()=> currentUser && saveUser(currentUser),
    clearStore: ()=> { clearUserStorage(); alert('storage cleared'); },
    openPurchaseModal
  };

}); // DOMContentLoaded end
</script>
</body>
</html>